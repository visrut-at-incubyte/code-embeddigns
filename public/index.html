<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D t-SNE Plot</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsne@1.0.1/tsne.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/default.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
    <style>
      body {
        margin: 0;
        display: flex;
        height: 100vh;
      }
      #plot {
        width: 50%;
        height: 100%;
      }
      #info {
        width: 50%;
        height: 100%;
        padding: 20px;
        overflow: hidden;
        border-left: 1px solid #ccc;
        box-sizing: border-box;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div id="plot"></div>
    <div id="info">
      <h2>File Information</h2>
      <div id="hover-info"></div>
      <h2>Source Code</h2>
      <pre><code id="source-code" class="hljs"></code></pre>
    </div>
    <script>
      async function fetchData() {
        const response = await fetch("data.json");
        const data = await response.json();
        return data;
      }

      async function runTSNEAndPlot() {
        const data = await fetchData();
        const vectors = data.map((item) => item.vector);

        const tsne = new tsnejs.tSNE({
          dim: 3,
          perplexity: 5,
          earlyExaggeration: 4.0,
          learningRate: 100.0,
          nIter: 1000,
          metric: "euclidean",
        });

        tsne.initDataRaw(vectors);
        for (let i = 0; i < 500; i++) {
          tsne.step();
        }

        const reducedVectors = tsne.getSolution();

        const scatterPlot = {
          x: reducedVectors.map((v) => v[0]),
          y: reducedVectors.map((v) => v[1]),
          z: reducedVectors.map((v) => v[2]),
          mode: "markers",
          type: "scatter3d",
          marker: {
            size: 5,
            color: "grey",
            opacity: 0.5,
            line: {
              color: "lightgray",
              width: 1,
            },
          },
          text: data.map((item) => item.base_name),
          sourceCode: data.map((item) => item.source_code),
          hoverinfo: "text",
        };

        const layout = {
          scene: {
            xaxis: { title: "X" },
            yaxis: { title: "Y" },
            zaxis: { title: "Z" },
          },
          title: "3D Representation after t-SNE (Perplexity=5)",
        };

        const plotData = [scatterPlot];

        Plotly.newPlot("plot", plotData, layout);

        document
          .getElementById("plot")
          .on("plotly_click", function (eventData) {
            const pointNumber = eventData.points[0].pointNumber;
            const sourceCode = eventData.points[0].data.sourceCode[pointNumber];
            const sourceCodeElement = document.getElementById("source-code");
            sourceCodeElement.textContent = sourceCode;
            hljs.highlightElement(sourceCodeElement);
          });
      }

      runTSNEAndPlot();
    </script>
  </body>
</html>
